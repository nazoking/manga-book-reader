var oe=Object.defineProperty;var ne=(o,e,t)=>e in o?oe(o,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):o[e]=t;var F=(o,e)=>()=>(e||o((e={exports:{}}).exports,e),e.exports);var q=(o,e,t)=>(ne(o,typeof e!="symbol"?e+"":e,t),t);var Z=F((Se,re)=>{re.exports='<div class="info controller"><div class="view-ctrl"><button class="fullscreen">\u{1F5D6}</button></div><div class="info-ctrl"><button class="nextBook">\u23EE</button><button class="nextPage">\u25C0</button><button class="nextHalf">\u2345</button><button class="prevHalf">\u2346</button><button class="prevPage">\u25B6</button><button class="prevBook">\u23ED</button></div><div class="book-title"></div></div><div class="pages"><div class="left page"><div class="left-page img"></div></div><div class="right page"><div class="right-page img"></div></div></div> '});var K=F((Ce,ie)=>{ie.exports=`:host{background:#333;z-index:2147483647;width:500px;height:300px;border:1px solid gray}:host>div{position:relative;margin:0;user-select:none;color:#000;overflow:hidden;touch-action:none;display:flex;flex-direction:column;height:100%;width:100%}:fullscreen{touch-action:none;border:none}:fullscreen.show-controllers .controller{opacity:.5}:fullscreen.show-controllers .controller:hover{opacity:.9}:fullscreen .controller{opacity:0}.controller *{pointer-events:none}.show-controllers .controller *{pointer-events:auto}button{font-family:"Segoe UI Emoji";color:#333;background:#cccccc;cursor:pointer;border:1px outset}button.disabled{cursor:default;opacity:.4}button.controller.disabled{opacity:0}.show-controllers button.controller.disabled:hover{opacity:.2;cursor:default}.info{background:white;position:relative;top:0;width:100%;justify-content:space-between;flex-direction:row-reverse;display:flex;flex-wrap:wrap;gap:10px;z-index:1}:fullscreen .info{position:absolute}.info .book-title select{user-select:text;justify-content:flex-start;border:none;appearance:none;padding:5px 0}:fullscreen .info .book-title select{padding:10px 0}.info .info-ctrl{display:flex;justify-content:space-evenly}.info .view-ctrl{display:flex;justify-content:flex-end}.info .book-title{flex-grow:1}.info button{padding:5px 15px}:fullscreen .info button{padding:10px 35px}.info button{line-height:18px;height:100%}.info .info-title{padding-right:15px}.pages{position:relative;inset:0;transform-origin:0 0;cursor:none;flex-grow:1;padding:0;margin:0}:fullscreen .pages{position:absolute}.show-controllers .pages{cursor:auto}.page{width:50%;float:left;height:100%;padding:0;margin:0}.img{width:100%;height:100%;background-repeat:no-repeat;background-size:contain;background-position-y:center}.img.broken-image{background-image:url(data:image/svg+xml;base64,PHN2ZyBjbGFzcz0ic3ZnLWljb24iIHN0eWxlPSJ3aWR0aDogMWVtOyBoZWlnaHQ6IDFlbTt2ZXJ0aWNhbC1hbGlnbjogbWlkZGxlO2ZpbGw6IGN1cnJlbnRDb2xvcjtvdmVyZmxvdzogaGlkZGVuOyIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgdmVyc2lvbj0iMS4xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPgo8cGF0aCBkPSJNODk2IDIxM3YyODFsLTEyOC0xMjgtMTcwIDE3MC0xNzAtMTcwLTE3MCAxNzAtMTI4LTEyOFYyMTNjMC00NiAzOC04NSA4NS04NWg1OTdjNDYgMCA4NSAzOCA4NSA4NXogbS0xMjggMjczbDEyOCAxMjhWODEwYzAgNDYtMzggODUtODUgODVIMjEzYy00NiAwLTg1LTM4LTg1LTg1VjUyOWwxMjggMTI4IDE3MC0xNzAgMTcwIDE3MCAxNzAtMTcweiIgIC8+Cjwvc3ZnPg==)!important;background-size:40%}.img.no-image{background-image:linear-gradient(45deg,black,#888)!important}.img.loading-image{animation:loading .5s ease-in alternate infinite}@keyframes loading{0%{background-color:#333}to{background-color:#888}}.left-page{background-position-x:right}.right-page{background-position-x:left}.single .left.page{display:none}.single .right.page{width:100%}.single .right-page{background-position-x:center}.move-button{position:absolute;font-size:40px;height:80%;top:10%}.left-button{left:60px}.right-button{right:60px}
`});function D(o,e,t){let n=()=>o.removeEventListener(e,r),r=i=>{n(),t(i)};return o.addEventListener(e,r),{cancel:n}}var G=(o,e)=>new Promise((t,n)=>{let r=new Image,i=setInterval(function(){r.naturalWidth&&(clearInterval(i),e({width:r.naturalWidth,height:r.naturalHeight}))},10),a=D(r,"load",()=>{c.cancel(),t(r)}),c=D(r,"error",()=>{a.cancel(),n(r)});r.src=o});var S=class{string;constructor(e){this.string=(e.shiftKey?"shift+":"")+(e.metaKey?"meta+":"")+(e.ctrlKey?"ctrl+":"")+(e.altKey?"alt+":"")+e.code}};var y=class{constructor(e,t){this.x=e;this.y=t}toString(){return`(${this.x};${this.y})`}div(e){return new y(this.x/e,this.y/e)}mul(e){return new y(this.x*e,this.y*e)}plus(e){return new y(this.x+e.x,this.y+e.y)}minus(e){return e?new y(this.x-e.x,this.y-e.y):new y(-this.x,-this.y)}distance(){return Math.sqrt(Math.pow(this.x,2)+Math.pow(this.y,2))}},h=y;q(h,"Zero",new y(0,0));var w=class{constructor(e,t,n){this.type=e;this.ev1=t;this.ev2=n;this.center=new h((this.ev1.clientX+this.ev2.clientX)/2,(this.ev1.clientY+this.ev2.clientY)/2)}center;get distance(){return Math.sqrt(Math.pow(this.ev1.screenX-this.ev2.screenX,2)+Math.pow(this.ev1.screenY-this.ev2.screenY,2))}};var k=class{constructor(e,t,n){this.type=e;this.center=t;this.distance=n}};var C=class{constructor(e){this.gestures=e}};var L=class{constructor(e=new Map){this.map=e}put(e){if(this.map.has(e.pointerId)){let t=this.map.get(e.pointerId);return this.map.set(e.pointerId,e),t}else{this.map.set(e.pointerId,e);return}}update(e){if(this.map.has(e.pointerId)){let t=this.map.get(e.pointerId);return this.map.set(e.pointerId,e),t}}delete(e){if(this.map.has(e.pointerId)){let t=this.map.get(e.pointerId);return this.map.delete(e.pointerId),t}}get size(){return this.map.size}values(){return Array.from(this.map.values())}};var E=class{constructor(e){this.handler=e;this.evCache=new L}evCache;dragging;handlers={pointerdown:e=>this.onPointerDown(e),pointermove:e=>this.onPointerMove(e),pointerup:e=>this.onPointerUp(e),pointercancel:e=>this.onPointerUp(e),pointerout:e=>this.onPointerUp(e),pointerleave:e=>this.onPointerUp(e),wheel:e=>this.onWheel(e)};attach(e){Object.entries(this.handlers).forEach(([t,n])=>e.addEventListener(t,n))}detach(e){Object.entries(this.handlers).forEach(([t,n])=>e.removeEventListener(t,n))}onPointerDown(e){if(this.evCache.put(e),this.evCache.size==2){let t=this.evCache.values();this.handler.onPinch(new w("pinchstart",t[0],t[1]))}this.evCache.size==1?this.dragging===void 0&&(this.dragging={ev:e,gestures:[]}):this.dragging=void 0}onPointerMove(e){if(this.evCache.update(e),this.evCache.size==2){let t=this.evCache.values();this.handler.onPinch(new w("pinchmove",t[0],t[1]))}if(this.dragging?.ev.pointerId===e.pointerId){let t=null;Math.abs(this.dragging.ev.clientX-e.clientX)>16?t=this.dragging.ev.clientX>e.clientX?"right":"left":Math.abs(this.dragging.ev.clientY-e.clientY)>16&&(t=this.dragging.ev.clientY>e.clientY?"up":"down"),this.dragging.lastDirection===t?this.dragging.ev=e:t&&(this.dragging.lastDirection=t,this.dragging.gestures.push(t),this.dragging.ev=e)}}onPointerUp(e){let t=this.evCache.delete(e);if(this.evCache.size==1&&t){let n=this.evCache.values();this.handler.onPinch(new w("pinchend",n[0],t))}this.dragging?.ev.pointerId===e.pointerId&&(this.dragging.gestures.length&&this.handler.onDraw(new C(this.dragging.gestures)),this.dragging=void 0)}onWheel(e){e.preventDefault(),e.ctrlKey?(this.handler.onPinch(new k("pinchstart",new h(e.clientX,e.clientY),100)),this.handler.onPinch(new k("pinchend",new h(e.clientX,e.clientY),100-e.deltaY))):(this.handler.onPinch(new k("pinchstart",new h(e.clientX,e.clientY),1)),this.handler.onPinch(new k("pinchend",new h(e.clientX+e.deltaX,e.clientY+e.deltaY),1)))}};var U=class{constructor(e,t,n){this.center=e;this.distance=t;this.transform=n}zoom(e,t){let n=t/this.distance,r=new DOMMatrixReadOnly().translate(e.x,e.y).scale(n,n).translate(-this.center.x,-this.center.y).multiply(this.transform);return r.a<.5||r.a>4?this.transform:r}},N=class{constructor(e){this.content=e;this.content=e,this.reset()}transform=new DOMMatrixReadOnly;ticking=!1;transformer;reset(){this.transform=new DOMMatrixReadOnly,this.requestElementUpdate()}onPinch(e){e.type=="pinchstart"&&(this.transformer=new U(e.center,e.distance,this.transform)),this.transformer&&(this.transform=this.transformer.zoom(e.center,e.distance),this.requestElementUpdate())}requestElementUpdate(){this.ticking||(window.requestAnimationFrame(()=>this.updateElement()),this.ticking=!0)}updateElement(){this.content.setTransform(this.transform),this.ticking=!1}};var x=class{constructor(e=[]){this.handlers=e}trigger(e){if(e){let t=!1;return this.handlers.forEach(n=>t||=n(e)),t}}add(e){this.handlers.push(e)}remove(e){let t=this.handlers.indexOf(e);t>=0&&this.handlers.splice(t,1)}};var M=(o=document)=>{let e=o.createElement("div");return e.innerHTML=Z()+`<style>${K()}</style>`,e};var ae=["loading-image","no-image","broken-image","show-image"],A=class{rightPage;leftPage;pages;bookTitle;infoTimer;zoom;onChanged=new x;wrapper;root;inner;constructor(e=M()){this.wrapper=e.ownerDocument.createElement("div"),this.root=this.wrapper.attachShadow({mode:"closed"}),this.root.appendChild(e),e.tabIndex=0,this.inner=e;let t=n=>{let r=this.root.querySelector(n);if(!r)throw Error(`div has not element "${n}" ${e.outerHTML}`);return r};this.rightPage=t(".right-page"),this.leftPage=t(".left-page"),this.pages=t(".pages"),this.bookTitle=t(".book-title"),this.inner.addEventListener("pointermove",n=>{n.pointerType!="touch"&&this.showControllers()})}setDrawHandler(e){this.zoom=new N({setTransform:n=>{this.pages.style.transform=n.toString()}}),new E({onPinch:n=>{this.zoom?.onPinch(n)},onDraw:n=>{e(n.gestures.join("-"))}}).attach(this.inner)}setClickHandler(e){this.inner.addEventListener("click",t=>{t.stopPropagation(),t.preventDefault();let n=t.target;for(;n&&n!=this.inner&&!e(n);){if(n.classList.contains("controller")){this.toggleControllers();break}n=n.parentElement}})}setKeyHandler(e){this.inner.addEventListener("keydown",t=>{e(new S(t))&&(t.preventDefault(),t.stopPropagation())},!0)}toggleControllers(){this.inner.classList.contains("show-controllers")?this.hideControllers():this.showControllers()}showControllers(){this.inner.classList.add("show-controllers"),clearTimeout(this.infoTimer),this.infoTimer=window.setTimeout(()=>{this.hideControllers()},3e3)}hideControllers(){this.inner.classList.remove("show-controllers")}zoomReset(){this.zoom?.reset()}get fullScreen(){return!!document.fullscreenElement}set fullScreen(e){e?this.inner.requestFullscreen():document.exitFullscreen().then(()=>{this.inner.focus()})}setTitle(e){typeof e=="string"?this.bookTitle.innerText=e:(this.bookTitle.innerText="",this.bookTitle.appendChild(e))}setPageImageType(e,t){e.classList.remove(...ae),t&&e.classList.add(t)}async setPageTypeSingleUnit(e){this.inner.classList.toggle("single",await e)}async setCurrent(e){this.zoomReset(),this.inner.dataset.pageNumber=`${e.pageNumber()}`;let t=async(n,r)=>{let i=await n;if(this.inner.dataset.pageNumber==`${e.pageNumber()}`)if(i){if(this.setPageImageType(r,"loading-image"),r.style.backgroundImage=`url("${encodeURI(i.src)}")`,typeof i.isWidePage=="boolean"){this.setPageImageType(r,"show-image"),this.setPageTypeSingleUnit(e.isSingleUnit());return}try{if(await G(i.src,({width:a,height:c})=>{this.inner.dataset.pageNumber==`${e.pageNumber()}`&&(i.isWidePage=c<a,this.setPageTypeSingleUnit(e.isSingleUnit()))}),this.inner.dataset.pageNumber!=`${e.pageNumber()}`)return;this.setPageImageType(r,"show-image")}catch{if(this.inner.dataset.pageNumber!=`${e.pageNumber()}`)return;throw this.setPageImageType(r,"broken-image"),new Error(`can't load ${i.src}`)}}else{this.setPageImageType(r,"no-image"),this.setPageTypeSingleUnit(e.isSingleUnit());return}};await Promise.all([t(e.image1(),this.rightPage),t(e.image2(),this.leftPage)]),this.onChanged.trigger(e)}};var B=class{constructor(e,t){this.bookController=e;this.setHandler=t}actions(){return{nextBook:{action:()=>{this.move(this.bookController.move(1),-1)},isEnable:async()=>this.bookController.canMove(1)},prevBook:{action:()=>{this.move(this.bookController.move(-1),-1)},isEnable:async()=>this.bookController.canMove(-1)},prevBookLast:{action:()=>{this.move(this.bookController.move(-1),{last:-1})},isEnable:async()=>this.bookController.canMove(-1)}}}move(e,t){typeof e=="number"&&(e=this.bookController.goTo(e)),this.bookController=e,this.setHandler(this.bookController,t)}getBookController(){return this.bookController}};function se(o){return o.startsWith("/")}var $=(o,e)=>{let t=e||document;if(se(o)){let n=document.evaluate(o,t);if(n.resultType==XPathResult.ORDERED_NODE_ITERATOR_TYPE||n.resultType==XPathResult.UNORDERED_NODE_ITERATOR_TYPE){let r=n.iterateNext(),i=[];for(;r;)i.push(r),r=n.iterateNext();return i}if(n.resultType==XPathResult.ORDERED_NODE_SNAPSHOT_TYPE||n.resultType==XPathResult.UNORDERED_NODE_SNAPSHOT_TYPE){let r=[];for(let i=0;i<n.snapshotLength;i++)r.push(n.snapshotItem(i));return r}throw new Error(`unsupported result type ${n.resultType} by ${o}`)}else return Array.from(t.querySelectorAll(o))};$.context=o=>e=>$(e,o);var f=$;async function le(o,e,t){console.log(`\u{1F4D6}append ${o}`),e.style.backgroundColor="red";let n=await fetch(o).then(p=>p.text()).then(p=>new DOMParser().parseFromString(p,"text/html")),r=f(t.nav,n)[0];if(!r){console.log(`\u{1F4D6}not found nav ${t.nav} in next page ${o}`);return}let i=f(t.contents,n)[0];if(!i){console.log(`\u{1F4D6}not found contents ${t.contents} in next page ${o}`);return}let a=document.createDocumentFragment();a.appendChild(i),a.appendChild(r),t.onLoad&&t.onLoad(a);let c=e.parentElement;if(!c)throw new Error("nav has not parent");c.insertBefore(a,e),c.removeChild(e),Y(t)}function Y(o){let e=f(o.nav)[0];if(!e){console.log(`\u{1F4D6}not found nav ${o.nav} in current page`);return}let t=f(o.next,e)[0];if(!t){console.log(`\u{1F4D6}not found next ${o.next} in current page`);return}let n=setInterval(()=>{e.getBoundingClientRect().top<window.innerHeight&&(clearInterval(n),le(t.href,e,o))},500)}var X;(t=>(t.of=(n,r)=>typeof n=="object"?r-n.last-2:n,t.inRange=(n,r)=>Math.min(Math.max(t.of(n,r),-1),r-1)))(X||={});var H=o=>{let e={getSpreadPages(t=0){let n=X.inRange(t,o.length),r=o[n]||null,i=o[n+1]||null,a={image1:()=>r,image2:()=>i,hasNext:async()=>n<o.length-1,nextPage:async()=>e.getSpreadPages(n+(await a.isSingleUnit()?1:2)),hasPrev:async()=>n>0,prevPage:async()=>e.getSpreadPages(n-((await o[n-1])?.isWidePage?1:2)),move:async c=>e.getSpreadPages(n+c),canMove:async c=>o[c]!==void 0,pageNumber:()=>n,isSingleUnit:async()=>(await r)?.isWidePage||(await i)?.isWidePage||!1};return a}};return e};var I=class{async hasNext(){return!1}async nextPage(){return this}async prevPage(){return this}async move(){return this}pageNumber(){return-1}async canMove(){return!1}async hasPrev(){return!1}image1(){return null}image2(){return null}async isSingleUnit(){return!0}};var v=class{constructor(e){this.internal=e;this.isEnable=m.isEnable(e)}isEnable;async action(){await this.isEnable()&&this.internal.action()}or(e){if(!e)return this;let t=m.wrap(e);return new v({action:async()=>await this.isEnable()?this.action():await t.isEnable()?t.action():!1,isEnable:async()=>await this.isEnable()||await t.isEnable()})}},m={NOP:void 0,wrap(o){return o?o instanceof v?o:typeof o=="function"?new v({action:()=>o()}):new v(o):m.NOP},isEnable(o){return"isEnable"in o?()=>o.isEnable():async()=>!0},lazy(o){return new v({action:()=>o().action(),isEnable:()=>m.isEnable(o())()})}};m.NOP=new v({action:()=>{}});var P=class{constructor(e,t,n,r){this.view=e;this.current=t;this.addActions((r||P.defaultActions).call(null,this)),e.setClickHandler(i=>{let a=Object.keys(this.clicks).find(c=>i.matches(c));if(a)return this.doAction(this.clicks[a]),!0}),e.setKeyHandler(i=>{if(this.keys[i.string])return this.doAction(this.keys[i.string]),!0}),e.setDrawHandler(i=>{if(this.draws[i])return this.doAction(this.draws[i]),!0}),n&&this.addActions(n),this.setCurrent(Promise.resolve(t))}keys={ArrowDown:"nextPageOrBook",Space:"nextPageOrBook",ArrowUp:"prevPageOrBook","shift+Space":"prevPageOrBook",ArrowLeft:"nextHalf",ArrowRight:"prevHalf",Enter:"toggleFullscreen",Period:"nextBook",Comma:"prevBook"};clicks={".right-button":"prevPageOrBook",".fullscreen":"toggleFullscreen",".pages":"nextPageOrBook",".nextBook":"nextBook",".prevBook":"prevBook",".nextPage":"nextPage",".prevPage":"prevPage",".nextHalf":"nextHalf",".prevHalf":"prevHalf"};actions={};draws={up:"toggleFullscreen",left:"nextPageOrBook",right:"prevPageOrBook","left-right":"nextHalf","right-left":"prevHalf","left-up":"nextBook","left-down":"prevBook",down:"zoomReset"};static defaultActions(e){return{nextPage:{action:()=>e.setCurrent(e.current.nextPage()),isEnable:()=>e.current.hasNext()},prevPage:{action:()=>e.setCurrent(e.current.prevPage()),isEnable:()=>e.current.hasPrev()},nextHalf:()=>e.setCurrent(e.current.move(1)),prevHalf:()=>e.setCurrent(e.current.move(-1)),fullscreen:{action:()=>e.view.fullScreen=!0,isEnable:async()=>!e.view.fullScreen},exitFullscreen:()=>e.view.fullScreen=!1,toggleFullscreen:()=>e.doAction(e.view.fullScreen?"exitFullscreen":"fullscreen"),nextPageOrBook:m.lazy(()=>m.wrap(e.actions.nextPage).or(e.actions.nextBook)),prevPageOrBook:m.lazy(()=>m.wrap(e.actions.prevPage).or(e.actions.prevBookLast)),firstPage:{action:()=>e.current.move(-1),isEnable:async()=>e.current.pageNumber()!=-1},firstPageOrPrevBook:m.lazy(()=>m.wrap(e.actions.firstPage).or(e.actions.prevBook)),zoomReset:()=>e.view.zoomReset()}}addActions(e){Object.entries(e).forEach(([t,n])=>this.addAction(t,n))}addAction(e,t){this.actions[e]=m.wrap(t)}getAction(e){if(e)return typeof e=="string"?this.getAction(this.actions[e]):m.wrap(e)}doAction(e){let t=this.getAction(e);t?t.action():typeof t=="string"&&console.log(`\u{1F4D6}unknown action ${e}`)}async setCurrent(e){this.current=await e,this.view.setCurrent(this.current),Object.entries(this.clicks).forEach(async([t,n])=>{let r=this.getAction(n),i=this.view.root.querySelectorAll(t);if(i.length){let a=r?!await r.isEnable():!0;Array.from(i).forEach(c=>{c.classList.toggle("disabled",a)})}})}};var O=class{map=new Map;async getOr(e,t){let n=this.map.get(e);if(n)return n;let r=await t(e);return this.map.set(e,r),r}};var z=({bookList:o,getBook:e,getName:t=(p,u)=>`Book ${u+1}`,onBookChanged:n=()=>{},onPageChanged:r=()=>{},dummyPage:i=new I,getBookSelector:a=({bookList:p,action:u,onBookChanged:b})=>{let g=document.createElement("select");return p.forEach((l,s,d)=>{g.appendChild(new Option(t(l,s,d)))}),g.onchange=()=>{u.move(g.selectedIndex,-1)},b.add(l=>{g.selectedIndex=l.bookIndex}),g},viewerDom:c=M()})=>{let p=new O,u=s=>(s=Math.min(Math.max(s,0),o.length),{move:d=>u(s+d),canMove:d=>s+d>=0&&s+d<o.length,goTo:d=>u(d),getBookMeta:()=>o[s],getSpreadPages:d=>p.getOr(o[s],T=>e(T,s,o)).then(T=>T.getSpreadPages(d))}),b=new x,g=new B(u(0),async(s,d)=>{l.setCurrent(Promise.resolve(i)),b.trigger({controller:s,bookIndex:o.findIndex(T=>T==s.getBookMeta())}),l.setCurrent(s.getSpreadPages(d)),n({book:s.getBookMeta(),page:d})}),l=new P(new A(c),i,g.actions());return l.view.onChanged.add(s=>{r({page:s.pageNumber(),book:g.getBookController().getBookMeta()})}),l.view.setTitle(a({bookList:o,action:g,onBookChanged:b})),{controller:l,action:g}};var R=async o=>{if(!o)return;let e=document.head.firstChild;for(let t of o)await new Promise(n=>{let r=document.createElement("link");r.setAttribute("rel","preload"),r.setAttribute("as","image"),r.setAttribute("href",t);let i=a=>{document.head.removeChild(r),a=="load error"&&console.log(`load error ${t}`),n()};r.onload=()=>i("loaded"),r.onerror=()=>i("load error"),document.head.insertBefore(r,e)})};var j=class{constructor(e="bookmark"){this.name=e}write(e){return document.cookie=`${this.name}=${encodeURIComponent(JSON.stringify(e))}; path=${document.location.pathname}; max-age=31536000; samesite`,Promise.resolve()}read(){let t=new Map(document.cookie.split(/; /).map(n=>n.split("=",2))).get(this.name);if(t)try{let n=JSON.parse(decodeURIComponent(t));return Promise.resolve(n)}catch{}return Promise.resolve(null)}};function ce(o){return o.length!=0&&o[0]instanceof Node}var V=o=>async e=>{let t=n=>{if(n.length==0)return n;if(ce(n)){if(n[0]instanceof HTMLAnchorElement)return t(n.map(r=>r.href));if(n[0]instanceof HTMLImageElement)return t(n.map(r=>r.dataset.lazySrc||r.dataset.src||r.src));throw new Error(`\u{1F4D6}Un Supported Node ${n[0]}`)}return n};return t(typeof o=="string"?f(o,e):typeof o=="object"?o:await o(e))},J=async o=>{let t=await(await fetch(o.url)).text(),n=new DOMParser().parseFromString(t,"text/html");if(n.getElementsByTagName("base").length==0){let r=n.createElement("base");r.href=o.url,n.head.append(r)}return n},_=async o=>{setTimeout(()=>R(o.pageList),1e3)},Q=o=>typeof o=="object"&&"loadBookPageList"in o,ee=o=>typeof o=="object"&&!Array.isArray(o)?{loadDom:o.loadDom?.bind(o)||J,parseDom:V(typeof o.parseDom=="function"?o.parseDom.bind(o):o.parseDom),postParse:o.postParse?.bind(o)||_}:{loadDom:J,parseDom:V(o),postParse:_},de=o=>{if(Q(o))return o;let e=ee(o);return{loadBookPageList:async t=>{let n=await e.loadDom(t),r=await e.parseDom(n);return await e.postParse({pageList:r,dom:n,book:t}),r}}},te=async({pageList:o,bookList:e=void 0,addController:t=void 0,bookmarker:n=new j,viewerDom:r=M()})=>{let i;if(!e||e.length==0){if(console.log("\u{1F4D6}bookList not found"),Q(o)){console.log("\u{1F4D6}pageList is BookLoader, but book info is not exists",o);return}let l=await ee(o).parseDom(document);if(!l.length){console.log("\u{1F4D6}pageList not found");return}i={loadBookPageList:async()=>l},e=[{title:document.title,url:location.href}]}else i=de(o);let a=await n.read(),c=e.findIndex(l=>l.title==a?.title),p=Math.max(c,0),u=(c!==-1?a?.page:-1)??-1;console.log("\u{1F4D6}start ",a,p,e,u);let{controller:b,action:g}=z({bookList:e,viewerDom:r,getBook:async l=>{console.log("\u{1F4D6}load=",l);let s=await i.loadBookPageList(l);return console.log("\u{1F4D6}pageList=",s),H(s.map(async d=>({src:d})))},getName:l=>l.title,onBookChanged:({book:l})=>{let s=window.location.href;history.replaceState({},"",l.url),history.replaceState({},"",s)},onPageChanged({page:l,book:s}){n.write({title:s.title,page:l}),console.log(`\u{1F4D6}open ${s.title}(${l})`)}});return W(b.view.wrapper,t),g.move(p,u),{controller:b,action:g}};function W(o,e){e?typeof e=="string"?W(o,f(e,document)[0]||document.body):typeof e=="function"?e(o):(e.prepend(o),setTimeout(()=>o.focus())):W(o,document.body)}var Mt={Book:H,ActionController:P,Viewer:A,BookLoadAction:B,DragHandler:E,multiBook:z,preLoadImageList:R,scraiping:te,infinityScroll:Y,query:f};export{Mt as default};
