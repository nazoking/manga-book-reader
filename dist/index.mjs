var G=Object.defineProperty;var _=(o,e,t)=>e in o?G(o,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):o[e]=t;var W=(o,e)=>()=>(e||o((e={exports:{}}).exports,e),e.exports);var X=(o,e,t)=>(_(o,typeof e!="symbol"?e+"":e,t),t);var Z=W((ke,J)=>{J.exports='<div class="info controller"><div class="view-ctrl"><button class="fullscreen">\u{1F5D6}</button></div><div class="info-ctrl"><button class="nextBook">\u23EE</button><button class="nextPage">\u25C0</button><button class="nextHalf">\u2345</button><button class="prevHalf">\u2346</button><button class="prevPage">\u25B6</button><button class="prevBook">\u23ED</button></div><div class="book-title"></div></div><div class="pages"><div class="left page"><div class="left-page img"></div></div><div class="right page"><div class="right-page img"></div></div></div> '});var V=W((Me,Q)=>{Q.exports=`#id{background:#333;position:relative;margin:0;user-select:none;width:500px;height:300px;color:#000;overflow:hidden;touch-action:none;z-index:2147483647;border:1px solid gray;display:flex;flex-direction:column}#id:fullscreen{touch-action:none;border:none}#id:fullscreen.show-controllers .controller{opacity:.5}#id:fullscreen.show-controllers .controller:hover{opacity:.9}#id:fullscreen .controller{opacity:0}#id .controller *{pointer-events:none}#id.show-controllers .controller *{pointer-events:auto}#id button{font-family:"Segoe UI Emoji";color:#333;background:#cccccc;cursor:pointer;border:1px outset}#id button.disabled{cursor:default;opacity:.4}#id button.controller.disabled{opacity:0}#id.show-controllers button.controller.disabled:hover{opacity:.2;cursor:default}#id .info{background:white;position:relative;top:0;width:100%;justify-content:space-between;flex-direction:row-reverse;display:flex;flex-wrap:wrap;gap:10px;z-index:1}#id:fullscreen .info{position:absolute}#id .info .book-title select{user-select:text;justify-content:flex-start;border:none;appearance:none;padding:5px 0}#id:fullscreen .info .book-title select{padding:10px 0}#id .info .info-ctrl{display:flex;justify-content:space-evenly}#id .info .view-ctrl{display:flex;justify-content:flex-end}#id .info .book-title{flex-grow:1}#id .info button{padding:5px 15px}#id:fullscreen .info button{padding:10px 35px}#id .info button{line-height:18px;height:100%}#id .info .info-title{padding-right:15px}#id .pages{position:relative;inset:0;transform-origin:0 0;cursor:none;flex-grow:1;padding:0;margin:0}#id:fullscreen .pages{position:absolute}#id.show-controllers .pages{cursor:auto}#id .page{width:50%;float:left;height:100%;padding:0;margin:0}#id .img{width:100%;height:100%;background-repeat:no-repeat;background-size:contain;background-position-y:center}#id .img.broken-image{background-image:url(data:text/plain;base64,PHN2ZyBjbGFzcz0ic3ZnLWljb24iIHN0eWxlPSJ3aWR0aDogMWVtOyBoZWlnaHQ6IDFlbTt2ZXJ0aWNhbC1hbGlnbjogbWlkZGxlO2ZpbGw6IGN1cnJlbnRDb2xvcjtvdmVyZmxvdzogaGlkZGVuOyIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgdmVyc2lvbj0iMS4xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPgo8cGF0aCBkPSJNODk2IDIxM3YyODFsLTEyOC0xMjgtMTcwIDE3MC0xNzAtMTcwLTE3MCAxNzAtMTI4LTEyOFYyMTNjMC00NiAzOC04NSA4NS04NWg1OTdjNDYgMCA4NSAzOCA4NSA4NXogbS0xMjggMjczbDEyOCAxMjhWODEwYzAgNDYtMzggODUtODUgODVIMjEzYy00NiAwLTg1LTM4LTg1LTg1VjUyOWwxMjggMTI4IDE3MC0xNzAgMTcwIDE3MCAxNzAtMTcweiIgIC8+Cjwvc3ZnPg==)!important;background-size:40%}#id .img.no-image{background-image:linear-gradient(45deg,black,#888)!important}#id .img.loading-image{animation:loading .5s ease-in alternate infinite}@keyframes loading{0%{background-color:#333}to{background-color:#888}}#id .left-page{background-position-x:right}#id .right-page{background-position-x:left}#id.single .left.page{display:none}#id.single .right.page{width:100%}#id.single .right-page{background-position-x:center}#id .move-button{position:absolute;font-size:40px;height:80%;top:10%}#id .left-button{left:60px}#id .right-button{right:60px}
`});function N(o,e,t){let n=()=>o.removeEventListener(e,r),r=i=>{n(),t(i)};return o.addEventListener(e,r),{cancel:n}}var F=(o,e)=>new Promise((t,n)=>{let r=new Image;var i=setInterval(function(){r.naturalWidth&&(clearInterval(i),e({width:r.naturalWidth,height:r.naturalHeight}))},10);let s=N(r,"load",m=>{l.cancel(),t(r)}),l=N(r,"error",m=>{s.cancel(),n(r)});r.src=o});var D=class{string;constructor(e){this.string=(e.shiftKey?"shift+":"")+(e.metaKey?"meta+":"")+(e.ctrlKey?"ctrl+":"")+(e.altKey?"alt+":"")+e.code}};var P=class{constructor(e,t){this.x=e;this.y=t}toString(){return`(${this.x};${this.y})`}div(e){return new P(this.x/e,this.y/e)}mul(e){return new P(this.x*e,this.y*e)}plus(e){return new P(this.x+e.x,this.y+e.y)}minus(e){return e?new P(this.x-e.x,this.y-e.y):new P(-this.x,-this.y)}distance(){return Math.sqrt(Math.pow(this.x,2)+Math.pow(this.y,2))}},v=P;X(v,"Zero",new P(0,0));var k=class{constructor(e,t,n){this.type=e;this.ev1=t;this.ev2=n;this.center=new v((this.ev1.clientX+this.ev2.clientX)/2,(this.ev1.clientY+this.ev2.clientY)/2)}center;get distance(){return Math.sqrt(Math.pow(this.ev1.screenX-this.ev2.screenX,2)+Math.pow(this.ev1.screenY-this.ev2.screenY,2))}};var x=class{constructor(e,t,n){this.type=e;this.center=t;this.distance=n}};var H=class{constructor(e){this.gestures=e}};var L=class{constructor(e=new Map){this.map=e}put(e){if(this.map.has(e.pointerId)){let t=this.map.get(e.pointerId);return this.map.set(e.pointerId,e),t}else{this.map.set(e.pointerId,e);return}}update(e){if(this.map.has(e.pointerId)){let t=this.map.get(e.pointerId);return this.map.set(e.pointerId,e),t}}delete(e){if(this.map.has(e.pointerId)){let t=this.map.get(e.pointerId);return this.map.delete(e.pointerId),t}}get size(){return this.map.size}values(){return Array.from(this.map.values())}};var M=class{constructor(e){this.handler=e;this.evCache=new L}evCache;dragging;handlers=[["pointerdown",e=>this.onPointerDown(e)],["pointermove",e=>this.onPointerMove(e)],["pointerup",e=>this.onPointerUp(e)],["pointercancel",e=>this.onPointerUp(e)],["pointerout",e=>this.onPointerUp(e)],["pointerleave",e=>this.onPointerUp(e)],["wheel",e=>this.onWheel(e)]];attach(e){this.handlers.forEach(([t,n])=>e.addEventListener(t,n))}detach(e){this.handlers.forEach(([t,n])=>e.removeEventListener(t,n))}onPointerDown(e){if(this.evCache.put(e),this.evCache.size==2){let t=this.evCache.values();this.handler.onPinch(new k("pinchstart",t[0],t[1]))}this.evCache.size==1?this.dragging===void 0&&(this.dragging={ev:e,gestures:[]}):this.dragging=void 0}onPointerMove(e){if(this.evCache.update(e),this.evCache.size==2){let t=this.evCache.values();this.handler.onPinch(new k("pinchmove",t[0],t[1]))}if(this.dragging?.ev.pointerId===e.pointerId){let t=null;Math.abs(this.dragging.ev.clientX-e.clientX)>16?t=this.dragging.ev.clientX>e.clientX?"right":"left":Math.abs(this.dragging.ev.clientY-e.clientY)>16&&(t=this.dragging.ev.clientY>e.clientY?"up":"down"),this.dragging.lastDirection===t?this.dragging.ev=e:t&&(this.dragging.lastDirection=t,this.dragging.gestures.push(t),this.dragging.ev=e)}}onPointerUp(e){let t=this.evCache.delete(e);if(this.evCache.size==1&&t){let n=this.evCache.values();this.handler.onPinch(new k("pinchend",n[0],t))}this.dragging?.ev.pointerId===e.pointerId&&(this.dragging.gestures.length&&this.handler.onDraw(new H(this.dragging.gestures)),this.dragging=void 0)}onWheel(e){e.preventDefault(),e.ctrlKey?(this.handler.onPinch(new x("pinchstart",new v(e.clientX,e.clientY),100)),this.handler.onPinch(new x("pinchend",new v(e.clientX,e.clientY),100-e.deltaY))):(this.handler.onPinch(new x("pinchstart",new v(e.clientX,e.clientY),1)),this.handler.onPinch(new x("pinchend",new v(e.clientX+e.deltaX,e.clientY+e.deltaY),1)))}};var U=class{constructor(e,t,n){this.center=e;this.distance=t;this.transform=n}zoom(e,t){let n=t/this.distance,r=new DOMMatrixReadOnly().translate(e.x,e.y).scale(n,n).translate(-this.center.x,-this.center.y).multiply(this.transform);return r.a<.5||r.a>4?this.transform:r}},I=class{constructor(e){this.content=e;this.content=e,this.reset()}transform=new DOMMatrixReadOnly;ticking=!1;transformer;reset(){this.transform=new DOMMatrixReadOnly,this.requestElementUpdate()}onPinch(e){e.type=="pinchstart"&&(this.transformer=new U(e.center,e.distance,this.transform)),this.transformer&&(this.transform=this.transformer.zoom(e.center,e.distance),this.requestElementUpdate())}requestElementUpdate(){this.ticking||(window.requestAnimationFrame(()=>this.updateElement()),this.ticking=!0)}updateElement(){this.content.setTransform(this.transform),this.ticking=!1}};var A=class{constructor(e=[]){this.handlers=e}trigger(e){if(e){let t=!1;return this.handlers.forEach(n=>t||=n(e)),t}}add(e){this.handlers.push(e)}remove(e){let t=this.handlers.indexOf(e);t>=0&&this.handlers.splice(t,1)}};var T=(o=document)=>{let e=o.createElement("div"),t="bookview-"+Math.random().toString(36).replace(/0\./,"");return e.id=t,e.tabIndex=0,e.innerHTML=Z()+`<style>${V().replace(/#id/g,`#${t}`)}</style>`,e};var ee=["loading-image","no-image","broken-image","show-image"],w=class{constructor(e=T()){this.div=e;this.rightPage=e.querySelector(".right-page"),this.leftPage=e.querySelector(".left-page"),this.pages=e.querySelector(".pages"),this.info=e.querySelector(".info"),this.bookTitle=e.querySelector(".book-title"),this.div=e,this.div.addEventListener("pointermove",t=>{t.pointerType!="touch"&&this.showControllers()})}rightPage;leftPage;pages;info;bookTitle;infoTimer;zoom;onChanged=new A;setDrawHandler(e){this.zoom=new I({setTransform:n=>{this.pages.style.transform=n.toString()}}),new M({onPinch:n=>{this.zoom?.onPinch(n)},onDraw:n=>{e(n.gestures.join("-"))}}).attach(this.div)}setClickHandler(e){this.div.addEventListener("click",t=>{t.stopPropagation(),t.preventDefault();let n=t.target;for(;n&&n!=this.div&&!e(n);){if(n.classList.contains("controller")){this.toggleControllers();break}n=n.parentElement}})}setKeyHandler(e){this.div.addEventListener("keydown",t=>{e(new D(t))&&(t.preventDefault(),t.stopPropagation())},!0)}toggleControllers(){this.div.classList.contains("show-controllers")?this.hideControllers():this.showControllers()}showControllers(){this.div.classList.add("show-controllers"),clearTimeout(this.infoTimer),this.infoTimer=window.setTimeout(()=>{this.hideControllers()},3e3)}hideControllers(){this.div.classList.remove("show-controllers")}zoomReset(){this.zoom?.reset()}get fullScreen(){return!!document.fullscreenElement}set fullScreen(e){e?this.div.requestFullscreen():document.exitFullscreen().then(()=>{this.div.focus()})}setTitle(e){typeof e=="string"?this.bookTitle.innerText=e:(this.bookTitle.innerText="",this.bookTitle.appendChild(e))}setPageImageType(e,t){e.classList.remove(...ee),t&&e.classList.add(t)}async setPageTypeSingleUnit(e){this.div.classList.toggle("single",await e)}async setCurrent(e){this.zoomReset(),this.div.dataset.pageNumber=`${e.pageNumber()}`;let t=async(n,r)=>{let i=await n;if(this.div.dataset.pageNumber==`${e.pageNumber()}`)if(i){if(this.setPageImageType(r,"loading-image"),r.style.backgroundImage=`url("${encodeURI(i.src)}")`,typeof i.isWidePage=="boolean"){this.setPageImageType(r,"show-image"),this.setPageTypeSingleUnit(e.isSingleUnit());return}try{let s=await F(i.src,({width:l,height:m})=>{this.div.dataset.pageNumber==`${e.pageNumber()}`&&(i.isWidePage=m<l,this.setPageTypeSingleUnit(e.isSingleUnit()))});if(this.div.dataset.pageNumber!=`${e.pageNumber()}`)return;this.setPageImageType(r,"show-image")}catch{if(this.div.dataset.pageNumber!=`${e.pageNumber()}`)return;throw this.setPageImageType(r,"broken-image"),new Error(`can't load ${i.src}`)}}else{this.setPageImageType(r,"no-image"),this.setPageTypeSingleUnit(e.isSingleUnit());return}};await Promise.all([t(e.image1(),this.rightPage),t(e.image2(),this.leftPage)]),this.onChanged.trigger(e)}};var B=class{constructor(e,t){this.bookController=e;this.setHandler=t}actions(){return{nextBook:{action:()=>{this.move(this.bookController.move(1),-1)},isEnable:async()=>this.bookController.canMove(1)},prevBook:{action:()=>{this.move(this.bookController.move(-1),-1)},isEnable:async()=>this.bookController.canMove(-1)},prevBookLast:{action:()=>{this.move(this.bookController.move(-1),{last:-1})},isEnable:async()=>this.bookController.canMove(-1)}}}move(e,t){typeof e=="number"&&(e=this.bookController.goTo(e)),this.bookController=e,this.setHandler(this.bookController,t)}};function te(o){return o.startsWith("/")}var j=(o,e)=>{let t=e||document;if(te(o)){let n=document.evaluate(o,t);if(n.resultType==XPathResult.ORDERED_NODE_ITERATOR_TYPE||n.resultType==XPathResult.UNORDERED_NODE_ITERATOR_TYPE){let r=n.iterateNext(),i=[];for(;r;)i.push(r),r=n.iterateNext();return i}if(n.resultType==XPathResult.ORDERED_NODE_SNAPSHOT_TYPE||n.resultType==XPathResult.UNORDERED_NODE_SNAPSHOT_TYPE){let r=[];for(let i=0;i<n.snapshotLength;i++)r.push(n.snapshotItem(i));return r}throw new Error(`unsupported result type ${n.resultType} by ${o}`)}else return Array.from(t.querySelectorAll(o))};j.context=o=>e=>j(e,o);var E=j;async function ne(o,e,t){console.log(`\u7D99\u304E\u8DB3\u3057 ${o}`),e.style.backgroundColor="red";let n=await fetch(o).then(m=>m.text()).then(m=>new DOMParser().parseFromString(m,"text/html")),r=E(t.nav,n)[0];if(!r){console.log(`\u6B21\u30DA\u30FC\u30B8 ${o} \u306E\u7D99\u304E\u8DB3\u3057\u90E8\u5206 ${t.nav} \u304C\u898B\u3064\u304B\u3089\u306A\u3044`);return}let i=n.querySelector(t.contents);if(!i){console.log(`\u6B21\u30DA\u30FC\u30B8 ${o} \u306E\u7D99\u304E\u8DB3\u3057\u90E8\u5206 ${t.contents} \u304C\u898B\u3064\u304B\u3089\u306A\u3044`);return}let s=document.createDocumentFragment();s.appendChild(i),s.appendChild(r),t.onLoad&&t.onLoad(s);let l=e.parentElement;l.insertBefore(s,e),l.removeChild(e),Y(t)}function Y(o){let e=E(o.nav)[0];if(!e){console.log(`\u73FE\u30DA\u30FC\u30B8\u306E nav ${o.nav} \u304C\u898B\u3064\u304B\u3089\u306A\u3044`);return}let t=E(o.next,e)[0];if(!t){console.log(`\u73FE\u30DA\u30FC\u30B8\u306E \u300C\u6B21\u306E\u30DA\u30FC\u30B8\u300D\u30EA\u30F3\u30AF ${o.next} \u304C\u898B\u3064\u304B\u3089\u306A\u3044`);return}let n=setInterval(()=>{e.getBoundingClientRect().top<window.innerHeight&&(clearInterval(n),ne(t.href,e,o))},500)}var q;(t=>(t.of=(n,r)=>typeof n=="object"?r-n.last-2:n,t.inRange=(n,r)=>Math.min(Math.max(t.of(n,r),-1),r-1)))(q||={});var S=o=>{let e={getSpreadPages(t=0){let n=q.inRange(t,o.length),r=o[n]||null,i=o[n+1]||null,s={image1:()=>r,image2:()=>i,hasNext:async()=>n<o.length-1,nextPage:async()=>e.getSpreadPages(n+(await s.isSingleUnit()?1:2)),hasPrev:async()=>n>0,prevPage:async()=>e.getSpreadPages(n-((await o[n-1])?.isWidePage?1:2)),move:async l=>e.getSpreadPages(n+l),canMove:async l=>o[l]!==void 0,pageNumber:()=>n,isSingleUnit:async()=>(await r)?.isWidePage||(await i)?.isWidePage||!1};return s}};return e};var O=class{async hasNext(){return!1}async nextPage(){return this}async prevPage(){return this}async move(){return this}pageNumber(){return-1}async canMove(){return!1}async hasPrev(){return!1}image1(){return null}image2(){return null}async isSingleUnit(){return!0}};var b=class{constructor(e){this.internal=e;this.isEnable=u.isEnable(e)}isEnable;async action(){await this.isEnable()&&this.internal.action()}or(e){if(!e)return this;let t=u.wrap(e);return new b({action:async()=>await this.isEnable()?this.action():await t.isEnable()?t.action():!1,isEnable:async()=>await this.isEnable()||await t.isEnable()})}},u={NOP:void 0,wrap(o){return o?o instanceof b?o:typeof o=="function"?new b({action:()=>o()}):new b(o):u.NOP},isEnable(o){return"isEnable"in o?()=>o.isEnable():async()=>!0},lazy(o){return new b({action:()=>o().action(),isEnable:()=>u.isEnable(o())()})}};u.NOP=new b({action:()=>{}});var y=class{constructor(e,t,n,r){this.view=e;this.current=t;this.addActions((r||y.defaultActions).call(null,this)),e.setClickHandler(i=>{let s=Object.keys(this.clicks).find(l=>i.matches(l));if(s)return this.doAction(this.clicks[s]),!0}),e.setKeyHandler(i=>{if(this.keys[i.string])return this.doAction(this.keys[i.string]),!0}),e.setDrawHandler(i=>{if(this.draws[i])return this.doAction(this.draws[i]),!0}),n&&this.addActions(n),this.setCurrent(Promise.resolve(t))}keys={ArrowDown:"nextPageOrBook",Space:"nextPageOrBook",ArrowUp:"prevPageOrBook","shift+Space":"prevPageOrBook",ArrowLeft:"nextHalf",ArrowRight:"prevHalf",Enter:"toggleFullscreen",Period:"nextBook",Comma:"prevBook"};clicks={".right-button":"prevPageOrBook",".fullscreen":"toggleFullscreen",".pages":"nextPageOrBook",".nextBook":"nextBook",".prevBook":"prevBook",".nextPage":"nextPage",".prevPage":"prevPage",".nextHalf":"nextHalf",".prevHalf":"prevHalf"};actions={};draws={up:"toggleFullscreen",left:"nextPageOrBook",right:"prevPageOrBook","left-right":"nextHalf","right-left":"prevHalf","left-up":"nextBook","left-down":"prevBook",down:"zoomReset"};static defaultActions(e){return{nextPage:{action:()=>e.setCurrent(e.current.nextPage()),isEnable:()=>e.current.hasNext()},prevPage:{action:()=>e.setCurrent(e.current.prevPage()),isEnable:()=>e.current.hasPrev()},nextHalf:()=>e.setCurrent(e.current.move(1)),prevHalf:()=>e.setCurrent(e.current.move(-1)),fullscreen:{action:()=>e.view.fullScreen=!0,isEnable:async()=>!e.view.fullScreen},exitFullscreen:()=>e.view.fullScreen=!1,toggleFullscreen:()=>e.doAction(e.view.fullScreen?"exitFullscreen":"fullscreen"),nextPageOrBook:u.lazy(()=>u.wrap(e.actions.nextPage).or(e.actions.nextBook)),prevPageOrBook:u.lazy(()=>u.wrap(e.actions.prevPage).or(e.actions.prevBookLast)),firstPage:{action:()=>e.current.move(-1),isEnable:async()=>e.current.pageNumber()!=-1},firstPageOrPrevBook:u.lazy(()=>u.wrap(e.actions.firstPage).or(e.actions.prevBook)),zoomReset:()=>e.view.zoomReset()}}addActions(e){Object.entries(e).forEach(([t,n])=>this.addAction(t,n))}addAction(e,t){this.actions[e]=u.wrap(t)}getAction(e){if(e)return typeof e=="string"?this.getAction(this.actions[e]):u.wrap(e)}doAction(e){let t=this.getAction(e);t?t.action():typeof t=="string"&&console.log(`unknown action ${e}`)}async setCurrent(e){this.current=await e,this.view.setCurrent(this.current),Object.entries(this.clicks).forEach(async([t,n])=>{let r=this.getAction(n),i=this.view.div.querySelectorAll(t);if(i.length){let s=r?!await r.isEnable():!0;Array.from(i).forEach(l=>{l.classList.toggle("disabled",s)})}})}};var z=class{map=new Map;async getOr(e,t){let n=this.map.get(e);if(n)return n;let r=await t(e);return this.map.set(e,r),r}};var R=({bookList:o,getBook:e,getName:t=(m,h)=>`Book ${h+1}`,onBookChanged:n=()=>{},onPageChanged:r=()=>{},dummyPage:i=new O,getBookSelector:s=({bookList:m,action:h,onBookChanged:c})=>{let p=document.createElement("select");return m.forEach((d,a,g)=>{p.appendChild(new Option(t(d,a,g)))}),p.onchange=()=>{h.move(p.selectedIndex,-1)},c.add(d=>{p.selectedIndex=d.bookIndex}),p},viewerDom:l=T()})=>{let m=new z,h=a=>(a=Math.min(Math.max(a,0),o.length),{move:g=>h(a+g),canMove:g=>a+g>=0&&a+g<o.length,goTo:g=>h(g),getBookMeta:()=>o[a],getSpreadPages:g=>m.getOr(o[a],f=>e(f,a,o)).then(f=>f.getSpreadPages(g))}),c=new A,p=new B(h(0),async(a,g)=>{d.setCurrent(Promise.resolve(i)),c.trigger({controller:a,bookIndex:o.findIndex(f=>f==a.getBookMeta())}),d.setCurrent(a.getSpreadPages(g)),n(a,g)}),d=new y(new w(l),i,p.actions());return d.view.onChanged.add(r),d.view.setTitle(s({bookList:o,action:p,onBookChanged:c})),{controller:d,action:p}};var C=async o=>{if(!o)return;let e=document.head.firstChild;for(let t of o)await new Promise(n=>{let r=document.createElement("link");r.setAttribute("rel","preload"),r.setAttribute("as","image"),r.setAttribute("href",t);let i=s=>{console.log(`${s} ${t}`),document.head.removeChild(r),n()};r.onload=()=>i("loaded"),r.onerror=()=>i("load error"),document.head.insertBefore(r,e)})};var $=class{write(e){return document.cookie=`lastchap=${escape(e.title)}; max-age=31536000; samesite`,typeof e.page=="number"&&(document.cookie=`page=${e.page}; max-age=31536000; samesite`),Promise.resolve()}read(){let e=new Map(document.cookie.split(/; /).map(r=>r.split("=",2))),t=e.get("lastchap"),n=null;if(t){n={title:unescape(t)};let r=e.get("page");r&&(n.page=r*1)}return Promise.resolve(n)}};function oe(o){return o.length!=0&&o[0]instanceof Node}var re=o=>async e=>{let t=n=>{if(n.length==0)return n;if(oe(n)){if(n[0]instanceof HTMLAnchorElement)return t(n.map(r=>r.href));if(n[0]instanceof HTMLImageElement)return t(n.map(r=>(r.dataset.lazySrc||r.dataset.src||r.src).trim()));throw new Error(`\u672A\u5BFE\u5FDC\u306E Node ${n[0]}`)}return n};return t(typeof o=="string"?E(o,e):typeof o=="string"||typeof o=="object"?o:await o(e))},K=async({pageList:o,bookList:e=void 0,addController:t=i=>{document.body.prepend(i),setTimeout(()=>i.focus())},bookmarker:n=new $,viewerDom:r=T()})=>{let i=re(o);if(!e||e.length==0){console.log("bookList \u306F\u898B\u3064\u304B\u308A\u307E\u305B\u3093");let c=await i(document);if(c.length){let p=S(c.map(async a=>({src:a}))),d=new y(new w(r),p.getSpreadPages(-1),{});return t(d.view.div),setTimeout(()=>C(c),1e3),{controller:d}}console.log("pageList \u3082\u898B\u3064\u304B\u308A\u307E\u305B\u3093");return}let s=await n.read(),l=Math.max(e.findIndex(c=>c.title==s?.title),0);console.log("start ",s,l,e);let{controller:m,action:h}=R({bookList:e,viewerDom:r,getBook:async c=>{console.log("load=",c);let d=await(await fetch(c.url)).text(),a=new DOMParser().parseFromString(d,"text/html");if(a.getElementsByTagName("base").length==0){let f=a.createElement("base");f.href=c.url,a.head.append(f)}let g=await i(a);return console.log("pageList=",g),setTimeout(()=>C(g),1e3),S(g.map(async f=>({src:f})))},getName:c=>c.title,onBookChanged:(c,p)=>{let d=c.getBookMeta();n.write({title:d.title});let a=window.location.href;history.replaceState({},"",d.url),history.replaceState({},"",a),console.log(`${JSON.stringify(c.getBookMeta())} ${d.title} ${JSON.stringify(p)}`)}});return t(m.view.div),h.move(l,-1),{controller:m,action:h}};var wt={Book:S,ActionController:y,Viewer:w,BookLoadAction:B,DragHandler:M,multiBook:R,preLoadImageList:C,scraiping:K,infinityScroll:Y,query:E};export{wt as default};
