var oe=Object.defineProperty;var ne=(t,e,o)=>e in t?oe(t,e,{enumerable:!0,configurable:!0,writable:!0,value:o}):t[e]=o;var W=(t,e)=>()=>(e||t((e={exports:{}}).exports,e),e.exports);var F=(t,e,o)=>(ne(t,typeof e!="symbol"?e+"":e,o),o);var Z=W((Se,re)=>{re.exports='<div class="info controller"><div class="view-ctrl"><button class="fullscreen">\u{1F5D6}</button></div><div class="info-ctrl"><button class="nextBook">\u23EE</button><button class="nextPage">\u25C0</button><button class="nextHalf">\u2345</button><button class="prevHalf">\u2346</button><button class="prevPage">\u25B6</button><button class="prevBook">\u23ED</button></div><div class="book-title"></div></div><div class="pages"><div class="left page"><div class="left-page img"></div></div><div class="right page"><div class="right-page img"></div></div></div> '});var K=W((Ce,ie)=>{ie.exports=`:host{background:#333;z-index:2147483647;width:500px;height:300px;border:1px solid gray}:host>div{position:relative;margin:0;user-select:none;color:#000;overflow:hidden;touch-action:none;display:flex;flex-direction:column;height:100%;width:100%}:fullscreen{touch-action:none;border:none}:fullscreen.show-controllers .controller{opacity:.5}:fullscreen.show-controllers .controller:hover{opacity:.9}:fullscreen .controller{opacity:0}.controller *{pointer-events:none}.show-controllers .controller *{pointer-events:auto}button{font-family:"Segoe UI Emoji";color:#333;background:#cccccc;cursor:pointer;border:1px outset}button.disabled{cursor:default;opacity:.4}button.controller.disabled{opacity:0}.show-controllers button.controller.disabled:hover{opacity:.2;cursor:default}.info{background:white;position:relative;top:0;width:100%;justify-content:space-between;flex-direction:row-reverse;display:flex;flex-wrap:wrap;gap:10px;z-index:1}:fullscreen .info{position:absolute}.info .book-title select{user-select:text;justify-content:flex-start;border:none;appearance:none;padding:5px 0}:fullscreen .info .book-title select{padding:10px 0}.info .info-ctrl{display:flex;justify-content:space-evenly}.info .view-ctrl{display:flex;justify-content:flex-end}.info .book-title{flex-grow:1}.info button{padding:5px 15px}:fullscreen .info button{padding:10px 35px}.info button{line-height:18px;height:100%}.info .info-title{padding-right:15px}.pages{position:relative;inset:0;transform-origin:0 0;cursor:none;flex-grow:1;padding:0;margin:0}:fullscreen .pages{position:absolute}.show-controllers .pages{cursor:auto}.page{width:50%;float:left;height:100%;padding:0;margin:0}.img{width:100%;height:100%;background-repeat:no-repeat;background-size:contain;background-position-y:center}.img.broken-image{background-image:url(data:image/svg+xml;base64,PHN2ZyBjbGFzcz0ic3ZnLWljb24iIHN0eWxlPSJ3aWR0aDogMWVtOyBoZWlnaHQ6IDFlbTt2ZXJ0aWNhbC1hbGlnbjogbWlkZGxlO2ZpbGw6IGN1cnJlbnRDb2xvcjtvdmVyZmxvdzogaGlkZGVuOyIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgdmVyc2lvbj0iMS4xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPgo8cGF0aCBkPSJNODk2IDIxM3YyODFsLTEyOC0xMjgtMTcwIDE3MC0xNzAtMTcwLTE3MCAxNzAtMTI4LTEyOFYyMTNjMC00NiAzOC04NSA4NS04NWg1OTdjNDYgMCA4NSAzOCA4NSA4NXogbS0xMjggMjczbDEyOCAxMjhWODEwYzAgNDYtMzggODUtODUgODVIMjEzYy00NiAwLTg1LTM4LTg1LTg1VjUyOWwxMjggMTI4IDE3MC0xNzAgMTcwIDE3MCAxNzAtMTcweiIgIC8+Cjwvc3ZnPg==)!important;background-size:40%}.img.no-image{background-image:linear-gradient(45deg,black,#888)!important}.img.loading-image{animation:loading .5s ease-in alternate infinite}@keyframes loading{0%{background-color:#333}to{background-color:#888}}.left-page{background-position-x:right}.right-page{background-position-x:left}.single .left.page{display:none}.single .right.page{width:100%}.single .right-page{background-position-x:center}.move-button{position:absolute;font-size:40px;height:80%;top:10%}.left-button{left:60px}.right-button{right:60px}
`});function D(t,e,o){let n=()=>t.removeEventListener(e,r),r=i=>{n(),o(i)};return t.addEventListener(e,r),{cancel:n}}var G=(t,e)=>new Promise((o,n)=>{let r=new Image;var i=setInterval(function(){r.naturalWidth&&(clearInterval(i),e({width:r.naturalWidth,height:r.naturalHeight}))},10);let s=D(r,"load",g=>{l.cancel(),o(r)}),l=D(r,"error",g=>{s.cancel(),n(r)});r.src=t});var S=class{string;constructor(e){this.string=(e.shiftKey?"shift+":"")+(e.metaKey?"meta+":"")+(e.ctrlKey?"ctrl+":"")+(e.altKey?"alt+":"")+e.code}};var v=class{constructor(e,o){this.x=e;this.y=o}toString(){return`(${this.x};${this.y})`}div(e){return new v(this.x/e,this.y/e)}mul(e){return new v(this.x*e,this.y*e)}plus(e){return new v(this.x+e.x,this.y+e.y)}minus(e){return e?new v(this.x-e.x,this.y-e.y):new v(-this.x,-this.y)}distance(){return Math.sqrt(Math.pow(this.x,2)+Math.pow(this.y,2))}},h=v;F(h,"Zero",new v(0,0));var w=class{constructor(e,o,n){this.type=e;this.ev1=o;this.ev2=n;this.center=new h((this.ev1.clientX+this.ev2.clientX)/2,(this.ev1.clientY+this.ev2.clientY)/2)}center;get distance(){return Math.sqrt(Math.pow(this.ev1.screenX-this.ev2.screenX,2)+Math.pow(this.ev1.screenY-this.ev2.screenY,2))}};var k=class{constructor(e,o,n){this.type=e;this.center=o;this.distance=n}};var C=class{constructor(e){this.gestures=e}};var L=class{constructor(e=new Map){this.map=e}put(e){if(this.map.has(e.pointerId)){let o=this.map.get(e.pointerId);return this.map.set(e.pointerId,e),o}else{this.map.set(e.pointerId,e);return}}update(e){if(this.map.has(e.pointerId)){let o=this.map.get(e.pointerId);return this.map.set(e.pointerId,e),o}}delete(e){if(this.map.has(e.pointerId)){let o=this.map.get(e.pointerId);return this.map.delete(e.pointerId),o}}get size(){return this.map.size}values(){return Array.from(this.map.values())}};var E=class{constructor(e){this.handler=e;this.evCache=new L}evCache;dragging;handlers=[["pointerdown",e=>this.onPointerDown(e)],["pointermove",e=>this.onPointerMove(e)],["pointerup",e=>this.onPointerUp(e)],["pointercancel",e=>this.onPointerUp(e)],["pointerout",e=>this.onPointerUp(e)],["pointerleave",e=>this.onPointerUp(e)],["wheel",e=>this.onWheel(e)]];attach(e){this.handlers.forEach(([o,n])=>e.addEventListener(o,n))}detach(e){this.handlers.forEach(([o,n])=>e.removeEventListener(o,n))}onPointerDown(e){if(this.evCache.put(e),this.evCache.size==2){let o=this.evCache.values();this.handler.onPinch(new w("pinchstart",o[0],o[1]))}this.evCache.size==1?this.dragging===void 0&&(this.dragging={ev:e,gestures:[]}):this.dragging=void 0}onPointerMove(e){if(this.evCache.update(e),this.evCache.size==2){let o=this.evCache.values();this.handler.onPinch(new w("pinchmove",o[0],o[1]))}if(this.dragging?.ev.pointerId===e.pointerId){let o=null;Math.abs(this.dragging.ev.clientX-e.clientX)>16?o=this.dragging.ev.clientX>e.clientX?"right":"left":Math.abs(this.dragging.ev.clientY-e.clientY)>16&&(o=this.dragging.ev.clientY>e.clientY?"up":"down"),this.dragging.lastDirection===o?this.dragging.ev=e:o&&(this.dragging.lastDirection=o,this.dragging.gestures.push(o),this.dragging.ev=e)}}onPointerUp(e){let o=this.evCache.delete(e);if(this.evCache.size==1&&o){let n=this.evCache.values();this.handler.onPinch(new w("pinchend",n[0],o))}this.dragging?.ev.pointerId===e.pointerId&&(this.dragging.gestures.length&&this.handler.onDraw(new C(this.dragging.gestures)),this.dragging=void 0)}onWheel(e){e.preventDefault(),e.ctrlKey?(this.handler.onPinch(new k("pinchstart",new h(e.clientX,e.clientY),100)),this.handler.onPinch(new k("pinchend",new h(e.clientX,e.clientY),100-e.deltaY))):(this.handler.onPinch(new k("pinchstart",new h(e.clientX,e.clientY),1)),this.handler.onPinch(new k("pinchend",new h(e.clientX+e.deltaX,e.clientY+e.deltaY),1)))}};var j=class{constructor(e,o,n){this.center=e;this.distance=o;this.transform=n}zoom(e,o){let n=o/this.distance,r=new DOMMatrixReadOnly().translate(e.x,e.y).scale(n,n).translate(-this.center.x,-this.center.y).multiply(this.transform);return r.a<.5||r.a>4?this.transform:r}},H=class{constructor(e){this.content=e;this.content=e,this.reset()}transform=new DOMMatrixReadOnly;ticking=!1;transformer;reset(){this.transform=new DOMMatrixReadOnly,this.requestElementUpdate()}onPinch(e){e.type=="pinchstart"&&(this.transformer=new j(e.center,e.distance,this.transform)),this.transformer&&(this.transform=this.transformer.zoom(e.center,e.distance),this.requestElementUpdate())}requestElementUpdate(){this.ticking||(window.requestAnimationFrame(()=>this.updateElement()),this.ticking=!0)}updateElement(){this.content.setTransform(this.transform),this.ticking=!1}};var x=class{constructor(e=[]){this.handlers=e}trigger(e){if(e){let o=!1;return this.handlers.forEach(n=>o||=n(e)),o}}add(e){this.handlers.push(e)}remove(e){let o=this.handlers.indexOf(e);o>=0&&this.handlers.splice(o,1)}};var M=(t=document)=>{let e=t.createElement("div");return e.innerHTML=Z()+`<style>${K()}</style>`,e};var ae=["loading-image","no-image","broken-image","show-image"],A=class{rightPage;leftPage;pages;info;bookTitle;infoTimer;zoom;onChanged=new x;wrapper;root;inner;constructor(e=M()){this.wrapper=e.ownerDocument.createElement("div"),this.root=this.wrapper.attachShadow({mode:"closed"}),this.root.appendChild(e),e.tabIndex=0,this.inner=e,this.rightPage=this.root.querySelector(".right-page"),this.leftPage=this.root.querySelector(".left-page"),this.pages=this.root.querySelector(".pages"),this.info=this.root.querySelector(".info"),this.bookTitle=this.root.querySelector(".book-title"),this.inner.addEventListener("pointermove",o=>{o.pointerType!="touch"&&this.showControllers()})}setDrawHandler(e){this.zoom=new H({setTransform:n=>{this.pages.style.transform=n.toString()}}),new E({onPinch:n=>{this.zoom?.onPinch(n)},onDraw:n=>{e(n.gestures.join("-"))}}).attach(this.inner)}setClickHandler(e){this.inner.addEventListener("click",o=>{o.stopPropagation(),o.preventDefault();let n=o.target;for(;n&&n!=this.inner&&!e(n);){if(n.classList.contains("controller")){this.toggleControllers();break}n=n.parentElement}})}setKeyHandler(e){this.inner.addEventListener("keydown",o=>{e(new S(o))&&(o.preventDefault(),o.stopPropagation())},!0)}toggleControllers(){this.inner.classList.contains("show-controllers")?this.hideControllers():this.showControllers()}showControllers(){this.inner.classList.add("show-controllers"),clearTimeout(this.infoTimer),this.infoTimer=window.setTimeout(()=>{this.hideControllers()},3e3)}hideControllers(){this.inner.classList.remove("show-controllers")}zoomReset(){this.zoom?.reset()}get fullScreen(){return!!document.fullscreenElement}set fullScreen(e){e?this.inner.requestFullscreen():document.exitFullscreen().then(()=>{this.inner.focus()})}setTitle(e){typeof e=="string"?this.bookTitle.innerText=e:(this.bookTitle.innerText="",this.bookTitle.appendChild(e))}setPageImageType(e,o){e.classList.remove(...ae),o&&e.classList.add(o)}async setPageTypeSingleUnit(e){this.inner.classList.toggle("single",await e)}async setCurrent(e){this.zoomReset(),this.inner.dataset.pageNumber=`${e.pageNumber()}`;let o=async(n,r)=>{let i=await n;if(this.inner.dataset.pageNumber==`${e.pageNumber()}`)if(i){if(this.setPageImageType(r,"loading-image"),r.style.backgroundImage=`url("${encodeURI(i.src)}")`,typeof i.isWidePage=="boolean"){this.setPageImageType(r,"show-image"),this.setPageTypeSingleUnit(e.isSingleUnit());return}try{let s=await G(i.src,({width:l,height:g})=>{this.inner.dataset.pageNumber==`${e.pageNumber()}`&&(i.isWidePage=g<l,this.setPageTypeSingleUnit(e.isSingleUnit()))});if(this.inner.dataset.pageNumber!=`${e.pageNumber()}`)return;this.setPageImageType(r,"show-image")}catch{if(this.inner.dataset.pageNumber!=`${e.pageNumber()}`)return;throw this.setPageImageType(r,"broken-image"),new Error(`can't load ${i.src}`)}}else{this.setPageImageType(r,"no-image"),this.setPageTypeSingleUnit(e.isSingleUnit());return}};await Promise.all([o(e.image1(),this.rightPage),o(e.image2(),this.leftPage)]),this.onChanged.trigger(e)}};var B=class{constructor(e,o){this.bookController=e;this.setHandler=o}actions(){return{nextBook:{action:()=>{this.move(this.bookController.move(1),-1)},isEnable:async()=>this.bookController.canMove(1)},prevBook:{action:()=>{this.move(this.bookController.move(-1),-1)},isEnable:async()=>this.bookController.canMove(-1)},prevBookLast:{action:()=>{this.move(this.bookController.move(-1),{last:-1})},isEnable:async()=>this.bookController.canMove(-1)}}}move(e,o){typeof e=="number"&&(e=this.bookController.goTo(e)),this.bookController=e,this.setHandler(this.bookController,o)}getBookController(){return this.bookController}};function se(t){return t.startsWith("/")}var Y=(t,e)=>{let o=e||document;if(se(t)){let n=document.evaluate(t,o);if(n.resultType==XPathResult.ORDERED_NODE_ITERATOR_TYPE||n.resultType==XPathResult.UNORDERED_NODE_ITERATOR_TYPE){let r=n.iterateNext(),i=[];for(;r;)i.push(r),r=n.iterateNext();return i}if(n.resultType==XPathResult.ORDERED_NODE_SNAPSHOT_TYPE||n.resultType==XPathResult.UNORDERED_NODE_SNAPSHOT_TYPE){let r=[];for(let i=0;i<n.snapshotLength;i++)r.push(n.snapshotItem(i));return r}throw new Error(`unsupported result type ${n.resultType} by ${t}`)}else return Array.from(o.querySelectorAll(t))};Y.context=t=>e=>Y(e,t);var f=Y;async function le(t,e,o){console.log(`\u{1F4D6}append ${t}`),e.style.backgroundColor="red";let n=await fetch(t).then(g=>g.text()).then(g=>new DOMParser().parseFromString(g,"text/html")),r=f(o.nav,n)[0];if(!r){console.log(`\u{1F4D6}not found nav ${o.nav} in next page ${t}`);return}let i=n.querySelector(o.contents);if(!i){console.log(`\u{1F4D6}not found contents ${o.contents} in next page ${t}`);return}let s=document.createDocumentFragment();s.appendChild(i),s.appendChild(r),o.onLoad&&o.onLoad(s);let l=e.parentElement;l.insertBefore(s,e),l.removeChild(e),$(o)}function $(t){let e=f(t.nav)[0];if(!e){console.log(`\u{1F4D6}not found nav ${t.nav} in current page`);return}let o=f(t.next,e)[0];if(!o){console.log(`\u{1F4D6}not found next ${t.next} in current page`);return}let n=setInterval(()=>{e.getBoundingClientRect().top<window.innerHeight&&(clearInterval(n),le(o.href,e,t))},500)}var X;(o=>(o.of=(n,r)=>typeof n=="object"?r-n.last-2:n,o.inRange=(n,r)=>Math.min(Math.max(o.of(n,r),-1),r-1)))(X||={});var N=t=>{let e={getSpreadPages(o=0){let n=X.inRange(o,t.length),r=t[n]||null,i=t[n+1]||null,s={image1:()=>r,image2:()=>i,hasNext:async()=>n<t.length-1,nextPage:async()=>e.getSpreadPages(n+(await s.isSingleUnit()?1:2)),hasPrev:async()=>n>0,prevPage:async()=>e.getSpreadPages(n-((await t[n-1])?.isWidePage?1:2)),move:async l=>e.getSpreadPages(n+l),canMove:async l=>t[l]!==void 0,pageNumber:()=>n,isSingleUnit:async()=>(await r)?.isWidePage||(await i)?.isWidePage||!1};return s}};return e};var I=class{async hasNext(){return!1}async nextPage(){return this}async prevPage(){return this}async move(){return this}pageNumber(){return-1}async canMove(){return!1}async hasPrev(){return!1}image1(){return null}image2(){return null}async isSingleUnit(){return!0}};var y=class{constructor(e){this.internal=e;this.isEnable=m.isEnable(e)}isEnable;async action(){await this.isEnable()&&this.internal.action()}or(e){if(!e)return this;let o=m.wrap(e);return new y({action:async()=>await this.isEnable()?this.action():await o.isEnable()?o.action():!1,isEnable:async()=>await this.isEnable()||await o.isEnable()})}},m={NOP:void 0,wrap(t){return t?t instanceof y?t:typeof t=="function"?new y({action:()=>t()}):new y(t):m.NOP},isEnable(t){return"isEnable"in t?()=>t.isEnable():async()=>!0},lazy(t){return new y({action:()=>t().action(),isEnable:()=>m.isEnable(t())()})}};m.NOP=new y({action:()=>{}});var P=class{constructor(e,o,n,r){this.view=e;this.current=o;this.addActions((r||P.defaultActions).call(null,this)),e.setClickHandler(i=>{let s=Object.keys(this.clicks).find(l=>i.matches(l));if(s)return this.doAction(this.clicks[s]),!0}),e.setKeyHandler(i=>{if(this.keys[i.string])return this.doAction(this.keys[i.string]),!0}),e.setDrawHandler(i=>{if(this.draws[i])return this.doAction(this.draws[i]),!0}),n&&this.addActions(n),this.setCurrent(Promise.resolve(o))}keys={ArrowDown:"nextPageOrBook",Space:"nextPageOrBook",ArrowUp:"prevPageOrBook","shift+Space":"prevPageOrBook",ArrowLeft:"nextHalf",ArrowRight:"prevHalf",Enter:"toggleFullscreen",Period:"nextBook",Comma:"prevBook"};clicks={".right-button":"prevPageOrBook",".fullscreen":"toggleFullscreen",".pages":"nextPageOrBook",".nextBook":"nextBook",".prevBook":"prevBook",".nextPage":"nextPage",".prevPage":"prevPage",".nextHalf":"nextHalf",".prevHalf":"prevHalf"};actions={};draws={up:"toggleFullscreen",left:"nextPageOrBook",right:"prevPageOrBook","left-right":"nextHalf","right-left":"prevHalf","left-up":"nextBook","left-down":"prevBook",down:"zoomReset"};static defaultActions(e){return{nextPage:{action:()=>e.setCurrent(e.current.nextPage()),isEnable:()=>e.current.hasNext()},prevPage:{action:()=>e.setCurrent(e.current.prevPage()),isEnable:()=>e.current.hasPrev()},nextHalf:()=>e.setCurrent(e.current.move(1)),prevHalf:()=>e.setCurrent(e.current.move(-1)),fullscreen:{action:()=>e.view.fullScreen=!0,isEnable:async()=>!e.view.fullScreen},exitFullscreen:()=>e.view.fullScreen=!1,toggleFullscreen:()=>e.doAction(e.view.fullScreen?"exitFullscreen":"fullscreen"),nextPageOrBook:m.lazy(()=>m.wrap(e.actions.nextPage).or(e.actions.nextBook)),prevPageOrBook:m.lazy(()=>m.wrap(e.actions.prevPage).or(e.actions.prevBookLast)),firstPage:{action:()=>e.current.move(-1),isEnable:async()=>e.current.pageNumber()!=-1},firstPageOrPrevBook:m.lazy(()=>m.wrap(e.actions.firstPage).or(e.actions.prevBook)),zoomReset:()=>e.view.zoomReset()}}addActions(e){Object.entries(e).forEach(([o,n])=>this.addAction(o,n))}addAction(e,o){this.actions[e]=m.wrap(o)}getAction(e){if(e)return typeof e=="string"?this.getAction(this.actions[e]):m.wrap(e)}doAction(e){let o=this.getAction(e);o?o.action():typeof o=="string"&&console.log(`\u{1F4D6}unknown action ${e}`)}async setCurrent(e){this.current=await e,this.view.setCurrent(this.current),Object.entries(this.clicks).forEach(async([o,n])=>{let r=this.getAction(n),i=this.view.root.querySelectorAll(o);if(i.length){let s=r?!await r.isEnable():!0;Array.from(i).forEach(l=>{l.classList.toggle("disabled",s)})}})}};var O=class{map=new Map;async getOr(e,o){let n=this.map.get(e);if(n)return n;let r=await o(e);return this.map.set(e,r),r}};var z=({bookList:t,getBook:e,getName:o=(g,u)=>`Book ${u+1}`,onBookChanged:n=()=>{},onPageChanged:r=()=>{},dummyPage:i=new I,getBookSelector:s=({bookList:g,action:u,onBookChanged:b})=>{let a=document.createElement("select");return g.forEach((d,c,p)=>{a.appendChild(new Option(o(d,c,p)))}),a.onchange=()=>{u.move(a.selectedIndex,-1)},b.add(d=>{a.selectedIndex=d.bookIndex}),a},viewerDom:l=M()})=>{let g=new O,u=c=>(c=Math.min(Math.max(c,0),t.length),{move:p=>u(c+p),canMove:p=>c+p>=0&&c+p<t.length,goTo:p=>u(p),getBookMeta:()=>t[c],getSpreadPages:p=>g.getOr(t[c],T=>e(T,c,t)).then(T=>T.getSpreadPages(p))}),b=new x,a=new B(u(0),async(c,p)=>{d.setCurrent(Promise.resolve(i)),b.trigger({controller:c,bookIndex:t.findIndex(T=>T==c.getBookMeta())}),d.setCurrent(c.getSpreadPages(p)),n({book:c.getBookMeta(),page:p})}),d=new P(new A(l),i,a.actions());return d.view.onChanged.add(c=>{r({page:c.pageNumber(),book:a.getBookController().getBookMeta()})}),d.view.setTitle(s({bookList:t,action:a,onBookChanged:b})),{controller:d,action:a}};var R=async t=>{if(!t)return;let e=document.head.firstChild;for(let o of t)await new Promise(n=>{let r=document.createElement("link");r.setAttribute("rel","preload"),r.setAttribute("as","image"),r.setAttribute("href",o);let i=s=>{document.head.removeChild(r),n()};r.onload=()=>i("loaded"),r.onerror=()=>i("load error"),document.head.insertBefore(r,e)})};var U=class{write(e){return document.cookie=`lastchap=${escape(e.title)}; max-age=31536000; samesite`,typeof e.page=="number"&&(document.cookie=`page=${e.page}; max-age=31536000; samesite`),Promise.resolve()}read(){let e=new Map(document.cookie.split(/; /).map(r=>r.split("=",2))),o=e.get("lastchap"),n=null;if(o){n={title:unescape(o)};let r=e.get("page");r&&(n.page=r*1)}return Promise.resolve(n)}};function ce(t){return t.length!=0&&t[0]instanceof Node}var V=t=>async e=>{let o=n=>{if(n.length==0)return n;if(ce(n)){if(n[0]instanceof HTMLAnchorElement)return o(n.map(r=>r.href));if(n[0]instanceof HTMLImageElement)return o(n.map(r=>r.dataset.lazySrc||r.dataset.src||r.src));throw new Error(`\u{1F4D6}Un Supported Node ${n[0]}`)}return n};return o(typeof t=="string"?f(t,e):typeof t=="object"?t:await t(e))},_=async t=>{let o=await(await fetch(t.url)).text(),n=new DOMParser().parseFromString(o,"text/html");if(n.getElementsByTagName("base").length==0){let r=n.createElement("base");r.href=t.url,n.head.append(r)}return n},J=async t=>{setTimeout(()=>R(t.pageList),1e3)},Q=t=>typeof t=="object"&&"loadBookPageList"in t,ee=t=>typeof t=="object"&&!Array.isArray(t)?{loadDom:t.loadDom?.bind(t)||_,parseDom:V(typeof t.parseDom=="function"?t.parseDom.bind(t):t.parseDom),postParse:t.postParse?.bind(t)||J}:{loadDom:_,parseDom:V(t),postParse:J},de=t=>{if(Q(t))return t;let e=ee(t);return{loadBookPageList:async o=>{let n=await e.loadDom(o),r=await e.parseDom(n);return await e.postParse({pageList:r,dom:n,book:o}),r}}},te=async({pageList:t,bookList:e=void 0,addController:o=void 0,bookmarker:n=new U,viewerDom:r=M()})=>{let i;if(!e||e.length==0){if(console.log("\u{1F4D6}bookList not found"),Q(t)){console.log("\u{1F4D6}pageList is BookLoader, but book info is not exists",t);return}let a=await ee(t).parseDom(document);if(!a.length){console.log("\u{1F4D6}pageList not found");return}i={loadBookPageList:async()=>a},e=[{title:document.title,url:location.href}]}else i=de(t);let s=await n.read(),l=Math.max(e.findIndex(a=>a.title==s?.title),0),g=s?.page??-1;console.log("\u{1F4D6}start ",s,l,e,g);let{controller:u,action:b}=z({bookList:e,viewerDom:r,getBook:async a=>{console.log("\u{1F4D6}load=",a);let d=await i.loadBookPageList(a);return console.log("\u{1F4D6}pageList=",d),N(d.map(async c=>({src:c})))},getName:a=>a.title,onBookChanged:({book:a})=>{let d=window.location.href;history.replaceState({},"",a.url),history.replaceState({},"",d)},onPageChanged({page:a,book:d}){n.write({title:d.title,page:a}),console.log(`\u{1F4D6}open ${d.title}(${a})`)}});return q(u.view.wrapper,o),b.move(l,g),{controller:u,action:b}};function q(t,e){e?typeof e=="string"?q(t,f(e,document)[0]||document.body):typeof e=="function"?e(t):(e.prepend(t),setTimeout(()=>t.focus())):q(t,document.body)}var Mt={Book:N,ActionController:P,Viewer:A,BookLoadAction:B,DragHandler:E,multiBook:z,preLoadImageList:R,scraiping:te,infinityScroll:$,query:f};export{Mt as default};
